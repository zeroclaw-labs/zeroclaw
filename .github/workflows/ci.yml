name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

concurrency:
    group: ci-${{ github.event.pull_request.number || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    CARGO_TERM_COLOR: always

jobs:
    changes:
        name: Detect Change Scope
        runs-on: ubuntu-latest
        outputs:
            docs_only: ${{ steps.scope.outputs.docs_only }}
            docs_changed: ${{ steps.scope.outputs.docs_changed }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect docs-only changes
              id: scope
              shell: bash
              run: |
                  set -euo pipefail

                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    BASE="${{ github.event.pull_request.base.sha }}"
                  else
                    BASE="${{ github.event.before }}"
                  fi

                  if [ -z "$BASE" ] || ! git cat-file -e "$BASE^{commit}" 2>/dev/null; then
                    echo "docs_only=false" >> "$GITHUB_OUTPUT"
                    echo "docs_changed=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  CHANGED="$(git diff --name-only "$BASE" HEAD || true)"
                  if [ -z "$CHANGED" ]; then
                    echo "docs_only=false" >> "$GITHUB_OUTPUT"
                    echo "docs_changed=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi

                  docs_only=true
                  docs_changed=false
                  while IFS= read -r file; do
                    [ -z "$file" ] && continue

                    if [[ "$file" == docs/* ]] \
                      || [[ "$file" == *.md ]] \
                      || [[ "$file" == *.mdx ]] \
                      || [[ "$file" == "LICENSE" ]] \
                      || [[ "$file" == ".markdownlint-cli2.yaml" ]] \
                      || [[ "$file" == .github/ISSUE_TEMPLATE/* ]] \
                      || [[ "$file" == .github/pull_request_template.md ]]; then
                      docs_changed=true
                      continue
                    fi

                    docs_only=false
                  done <<< "$CHANGED"

                  echo "docs_only=$docs_only" >> "$GITHUB_OUTPUT"
                  echo "docs_changed=$docs_changed" >> "$GITHUB_OUTPUT"

    lint:
        name: Format & Lint
        needs: [changes]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
                  components: rustfmt, clippy
            - uses: Swatinem/rust-cache@v2
            - name: Run rustfmt
              run: cargo fmt --all -- --check
            - name: Run clippy
              run: cargo clippy --locked --all-targets -- -D warnings

    test:
        name: Test
        needs: [changes]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
            - uses: Swatinem/rust-cache@v2
            - name: Run tests
              run: cargo test --locked --verbose

    build:
        name: Build (Smoke)
        needs: [changes]
        if: needs.changes.outputs.docs_only != 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 20

        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: 1.92
            - uses: Swatinem/rust-cache@v2
            - name: Build release binary
              run: cargo build --release --locked --verbose

    docs-only:
        name: Docs-Only Fast Path
        needs: [changes]
        if: needs.changes.outputs.docs_only == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Skip heavy jobs for docs-only change
              run: echo "Docs-only change detected. Rust lint/test/build skipped."

    docs-quality:
        name: Docs Quality
        needs: [changes]
        if: needs.changes.outputs.docs_changed == 'true'
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - uses: actions/checkout@v4

            - name: Markdown lint
              uses: DavidAnson/markdownlint-cli2-action@v20
              with:
                  globs: |
                      README.md
                      CONTRIBUTING.md
                      docs/**/*.md
                      docs/**/*.mdx
                      .github/pull_request_template.md

            - name: Link check (offline)
              uses: lycheeverse/lychee-action@v2
              with:
                  fail: true
                  args: >-
                      --offline
                      --no-progress
                      --exclude-mail
                      --format detailed
                      README.md
                      CONTRIBUTING.md
                      docs/**/*.md
                      docs/**/*.mdx
                      .github/pull_request_template.md
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    ci-required:
        name: CI Required Gate
        if: always()
        needs: [changes, lint, test, build, docs-only, docs-quality]
        runs-on: ubuntu-latest
        steps:
            - name: Enforce required status
              shell: bash
              run: |
                  set -euo pipefail

                  docs_changed="${{ needs.changes.outputs.docs_changed }}"
                  docs_result="${{ needs.docs-quality.result }}"

                  if [ "${{ needs.changes.outputs.docs_only }}" = "true" ]; then
                    echo "docs=${docs_result}"
                    if [ "$docs_result" != "success" ]; then
                      echo "Docs-only change requires docs-quality to pass."
                      exit 1
                    fi
                    echo "Docs-only fast path passed."
                    exit 0
                  fi

                  lint_result="${{ needs.lint.result }}"
                  test_result="${{ needs.test.result }}"
                  build_result="${{ needs.build.result }}"

                  echo "lint=${lint_result}"
                  echo "test=${test_result}"
                  echo "build=${build_result}"
                  echo "docs=${docs_result}"

                  if [ "$lint_result" != "success" ] || [ "$test_result" != "success" ] || [ "$build_result" != "success" ]; then
                    echo "Required CI jobs did not pass."
                    exit 1
                  fi

                  if [ "$docs_changed" = "true" ] && [ "$docs_result" != "success" ]; then
                    echo "Docs changed but docs-quality did not pass."
                    exit 1
                  fi

                  echo "All required CI jobs passed."
