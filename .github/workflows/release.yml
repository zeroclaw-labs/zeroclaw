name: Release

on:
    push:
        tags: ["v*"]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    android-release:
        name: Build Android APK and publish release
        runs-on: ubuntu-latest
        timeout-minutes: 90
        defaults:
            run:
                working-directory: mobile-app
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: mobile-app/package-lock.json

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Install mobile app dependencies
              run: npm ci

            - name: Generate Android native project
              env:
                  CI: "1"
              run: npx expo prebuild --platform android

            - name: Tune Android Gradle config for CI
              run: |
                  set -euo pipefail
                  {
                    echo "org.gradle.parallel=false"
                    echo "org.gradle.workers.max=2"
                    echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1536m -Dkotlin.daemon.jvm.options=-Xmx2048m,XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8"
                    echo "kotlin.daemon.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=1024m"
                  } >> android/gradle.properties

            - name: Validate signing secrets
              run: |
                  set -euo pipefail
                  test -n "${{ secrets.ANDROID_RELEASE_KEYSTORE_B64 }}"
                  test -n "${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}"
                  test -n "${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}"
                  test -n "${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}"

            - name: Decode Android keystore
              run: |
                  set -euo pipefail
                  mkdir -p android/app
                  printf '%s' "${{ secrets.ANDROID_RELEASE_KEYSTORE_B64 }}" | base64 --decode > android/app/release.keystore

            - name: Build release APK
              env:
                  JAVA_TOOL_OPTIONS: -XX:MaxMetaspaceSize=1536m
                  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1536m -Dkotlin.daemon.jvm.options=-Xmx2048m,XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8"
              run: |
                  ./gradlew :app:assembleRelease --no-daemon --max-workers=2 -Dkotlin.compiler.execution.strategy=in-process \
                    -PnewArchEnabled=false \
                    -PreactNativeArchitectures=arm64-v8a \
                    -Pandroid.injected.signing.store.file=app/release.keystore \
                    -Pandroid.injected.signing.store.password="${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}" \
                    -Pandroid.injected.signing.key.alias="${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}" \
                    -Pandroid.injected.signing.key.password="${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}"
              working-directory: mobile-app/android

            - name: Prepare release assets
              run: |
                  set -euo pipefail
                  VERSION="${GITHUB_REF_NAME}"
                  RELEASE_DIR="release-artifacts"
                  APK_SOURCE="android/app/build/outputs/apk/release/app-release.apk"
                  APK_NAME="mobileclaw-${VERSION}.apk"

                  mkdir -p "$RELEASE_DIR"
                  cp "$APK_SOURCE" "$RELEASE_DIR/$APK_NAME"
                  (
                    cd "$RELEASE_DIR"
                    sha256sum "$APK_NAME" > SHA256SUMS
                  )

            - name: Upload release artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: mobileclaw-android-release
                  path: |
                      mobile-app/release-artifacts/*.apk
                      mobile-app/release-artifacts/SHA256SUMS

            - name: Create GitHub Release
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
              with:
                  generate_release_notes: true
                  files: |
                      mobile-app/release-artifacts/*.apk
                      mobile-app/release-artifacts/SHA256SUMS
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Cleanup signing keystore
              if: always()
              run: rm -f android/app/release.keystore
